{*******************************************************}
{                                                       }
{       Tool di rimozione virus razzista su NAPOLI      }
{                                                       }
{            Copyright (C) 2021 Aloe Luigi              }
{             Rilasciato sotto licenza GPL2             }
{*******************************************************}



unit av;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
  System.Classes, Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs,
  System.Hash, Vcl.Imaging.jpeg, Vcl.ExtCtrls, Vcl.StdCtrls, Vcl.ComCtrls,
  AdvWiiProgressBar;

type
  TForm2 = class(TForm)
    Button1: TButton;
    Image1: TImage;
    AdvWiiProgressBar1: TAdvWiiProgressBar;
    Label1: TLabel;
    Label2: TLabel;
    procedure Button1Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form2: TForm2;

const
  sha1 = 'b114ae50ae6f7b0a10320c56374bffefe6c7a31a';
const
  sha256 = 'df7a7545740cb004efb243a6b99eb19a82c06dd49e5cd40f498a2c3ef9cf1d11';
const
  sha384 = '7cf2d0ff7d33be1e820add8f1e8907a50cee51e4f9f08afde62ff8f3471eec1d4d34a32722c29821973d1ca5a1e042ac';

implementation

uses
  System.IOUtils, System.StrUtils;
{$R *.dfm}

{$REGION 'Funzioni hash file'}
function GetFileHashSHA1(FileName: WideString): string;
var
  HashSHA: THashSHA1;
  Stream: TStream;
  Readed: Integer;
  Buffer: PByte;
  BufLen: Integer;
begin
  HashSHA := THashSHA1.Create;
  BufLen := 16 * 1024;
  Buffer := AllocMem(BufLen);
  try
    Stream := TFileStream.Create(FileName, fmOpenRead or fmShareDenyWrite);
    try
      while Stream.Position < Stream.Size do
      begin
        Readed := Stream.Read(Buffer^, BufLen);
        if Readed > 0 then
        begin
          HashSHA.update(Buffer^, Readed);
        end;
      end;
    finally
      Stream.Free;
    end;
  finally
    FreeMem(Buffer)
  end;
  result := HashSHA.HashAsString;
end;

function GetFileHashSHA256(FileName: WideString): string;
var
  HashSHA: THashSHA2;
  Stream: TStream;
  Readed: Integer;
  Buffer: PByte;
  BufLen: Integer;
begin
  HashSHA := THashSHA2.Create(THashSHA2.TSHA2Version.SHA256);
  BufLen := 16 * 1024;
  Buffer := AllocMem(BufLen);
  try
    Stream := TFileStream.Create(FileName, fmOpenRead or fmShareDenyWrite);
    try
      while Stream.Position < Stream.Size do
      begin
        Readed := Stream.Read(Buffer^, BufLen);
        if Readed > 0 then
        begin
          HashSHA.update(Buffer^, Readed);
        end;
      end;
    finally
      Stream.Free;
    end;
  finally
    FreeMem(Buffer)
  end;
  result := HashSHA.HashAsString;
end;

function GetFileHashSHA384(FileName: WideString): string;
var
  HashSHA: THashSHA2;
  Stream: TStream;
  Readed: Integer;
  Buffer: PByte;
  BufLen: Integer;
begin
  HashSHA := THashsha2.Create(THashSHA2.TSHA2Version.SHA384);
  BufLen := 16 * 1024;
  Buffer := AllocMem(BufLen);
  try
    Stream := TFileStream.Create(FileName, fmOpenRead or fmShareDenyWrite);
    try
      while Stream.Position < Stream.Size do
      begin
        Readed := Stream.Read(Buffer^, BufLen);
        if Readed > 0 then
        begin
          HashSHA.update(Buffer^, Readed);
        end;
      end;
    finally
      Stream.Free;
    end;
  finally
    FreeMem(Buffer)
  end;
  result := HashSHA.HashAsString;
end;
{$ENDREGION}

{$REGION 'Scansione virus razzista'}
procedure TForm2.Button1Click(Sender: TObject);
var
  files: TStringList;
  perc, hash,hash2,hash3: string;
begin
  with TFileOpenDialog.Create(nil) do
  try
    Options := [fdoPickFolders];
    if Execute then
      perc := FileName;
  finally
    Free;
  end;
  TThread.CreateAnonymousThread(
  procedure
  begin
  AdvWiiProgressBar1.Enabled:=true;
  files := TStringList.Create;
  files.AddStrings(TDirectory.GetFiles(perc));
for var i:integer := 0 to files.Count - 1 do
  begin
Hash:=GetFileHashSHA1(Files[i]);
hash2:=GetFileHashSha256(files[i]);
hash3:=GetFileHashSha384(files[i]);
label1.Caption:='Scansione in corso...attendi un attimo';
if (hash = sha1) or (hash2 = sha256) or (hash3 = sha384) then
    begin
    tthread.CreateAnonymousThread(procedure
    begin
     Label2.Visible:=true;
      end).Start;
deletefile(files[i]);
    end;
  end;
  files.DisposeOf;
  AdvWiiProgressBar1.Enabled:=false;
Label1.Caption:='Scansione completata';
end).Start;
end;
{$ENDREGION}

end.

